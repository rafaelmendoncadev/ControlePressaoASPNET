@model ControlePressao.Models.RelatorioResultViewModel

@{
    ViewData["Title"] = "Visualização do Relatório";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Cabeçalho -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-file-medical me-2"></i>
                        Relatório de Saúde - @Model.TipoRelatorio.ToString()
                    </h4>
                    <div>
                        <a href="@Url.Action("Gerar", new { 
                            DataInicial = Model.DataInicial, 
                            DataFinal = Model.DataFinal, 
                            TipoRelatorio = Model.TipoRelatorio, 
                            FormatoExportacao = FormatoExportacao.PDF 
                        })" class="btn btn-light btn-sm me-2">
                            <i class="fas fa-file-pdf me-1"></i>
                            PDF
                        </a>
                        <a href="@Url.Action("Gerar", new { 
                            DataInicial = Model.DataInicial, 
                            DataFinal = Model.DataFinal, 
                            TipoRelatorio = Model.TipoRelatorio, 
                            FormatoExportacao = FormatoExportacao.Excel 
                        })" class="btn btn-success btn-sm">
                            <i class="fas fa-file-excel me-1"></i>
                            Excel
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6><strong>Paciente:</strong> @Model.Usuario.Nome</h6>
                            <p class="mb-1"><strong>Email:</strong> @Model.Usuario.Email</p>
                            @if (Model.Usuario.DataNascimento.HasValue)
                            {
                                var idade = DateTime.Today.Year - Model.Usuario.DataNascimento.Value.Year;
                                if (Model.Usuario.DataNascimento.Value.Date > DateTime.Today.AddYears(-idade)) idade--;
                                <p class="mb-1"><strong>Idade:</strong> @idade anos</p>
                            }
                        </div>
                        <div class="col-md-4 text-end">
                            <p class="mb-1"><strong>Período:</strong> @Model.DataInicial.ToString("dd/MM/yyyy") a @Model.DataFinal.ToString("dd/MM/yyyy")</p>
                            <p class="mb-1"><strong>Gerado em:</strong> @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas Críticos -->
            @if (Model.Analise.AlertasCriticos.Any())
            {
                <div class="card shadow mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Alertas Críticos
                        </h5>
                    </div>
                    <div class="card-body">
                        @foreach (var alerta in Model.Analise.AlertasCriticos)
                        {
                            <div class="alert alert-danger mb-2">
                                @alerta
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Análise da Pressão Arterial -->
            @if (Model.Analise.AnalisesPressao != null)
            {
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-heartbeat me-2"></i>
                            Análise da Pressão Arterial
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Total de medições:</strong></td>
                                            <td>@Model.Analise.AnalisesPressao.TotalMedicoes</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Média sistólica:</strong></td>
                                            <td>@Model.Analise.AnalisesPressao.MediaSistolica mmHg</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Média diastólica:</strong></td>
                                            <td>@Model.Analise.AnalisesPressao.MediaDiastolica mmHg</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Média FC:</strong></td>
                                            <td>@Model.Analise.AnalisesPressao.MediaFrequenciaCardiaca bpm</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Classificação predominante:</strong></td>
                                            <td>
                                                <span class="badge bg-secondary">@Model.Analise.AnalisesPressao.ClassificacaoPredominate</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>% Hipertensão:</strong></td>
                                            <td>
                                                <span class="badge @(Model.Analise.AnalisesPressao.PercentualHipertensao > 50 ? "bg-danger" : Model.Analise.AnalisesPressao.PercentualHipertensao > 25 ? "bg-warning" : "bg-success")">
                                                    @Model.Analise.AnalisesPressao.PercentualHipertensao%
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tendência:</strong></td>
                                            <td>@Model.Analise.AnalisesPressao.TendenciaGeral</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        @if (Model.Analise.AnalisesPressao.Observacoes.Any())
                        {
                            <div class="mt-3">
                                <h6><strong>Observações:</strong></h6>
                                <ul>
                                    @foreach (var obs in Model.Analise.AnalisesPressao.Observacoes)
                                    {
                                        <li>@obs</li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Análise da Glicose -->
            @if (Model.Analise.AnalisesGlicose != null)
            {
                <div class="card shadow mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-droplet me-2"></i>
                            Análise da Glicose
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Total de medições:</strong></td>
                                            <td>@Model.Analise.AnalisesGlicose.TotalMedicoes</td>
                                        </tr>
                                        @if (Model.Analise.AnalisesGlicose.MediaJejum > 0)
                                        {
                                            <tr>
                                                <td><strong>Média jejum:</strong></td>
                                                <td>@Model.Analise.AnalisesGlicose.MediaJejum mg/dL</td>
                                            </tr>
                                        }
                                        @if (Model.Analise.AnalisesGlicose.MediaPosRefeicao > 0)
                                        {
                                            <tr>
                                                <td><strong>Média pós-refeição:</strong></td>
                                                <td>@Model.Analise.AnalisesGlicose.MediaPosRefeicao mg/dL</td>
                                            </tr>
                                        }
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Classificação predominante:</strong></td>
                                            <td>
                                                <span class="badge bg-secondary">@Model.Analise.AnalisesGlicose.ClassificacaoPredominate</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>% Valores alterados:</strong></td>
                                            <td>
                                                <span class="badge @(Model.Analise.AnalisesGlicose.PercentualAlteradas > 50 ? "bg-danger" : Model.Analise.AnalisesGlicose.PercentualAlteradas > 25 ? "bg-warning" : "bg-success")">
                                                    @Model.Analise.AnalisesGlicose.PercentualAlteradas%
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Controle glicêmico:</strong></td>
                                            <td>@Model.Analise.AnalisesGlicose.ControleGlicemico</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        @if (Model.Analise.AnalisesGlicose.Observacoes.Any())
                        {
                            <div class="mt-3">
                                <h6><strong>Observações:</strong></h6>
                                <ul>
                                    @foreach (var obs in Model.Analise.AnalisesGlicose.Observacoes)
                                    {
                                        <li>@obs</li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Análise de Peso e IMC -->
            @if (Model.Analise.AnalisesPeso != null)
            {
                <div class="card shadow mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-weight me-2"></i>
                            Análise de Peso e IMC
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Total de medições:</strong></td>
                                            <td>@Model.Analise.AnalisesPeso.TotalMedicoes</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Peso médio:</strong></td>
                                            <td>@Model.Analise.AnalisesPeso.MediaPeso kg</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Altura média:</strong></td>
                                            <td>@Model.Analise.AnalisesPeso.MediaAltura cm</td>
                                        </tr>
                                        <tr>
                                            <td><strong>IMC médio:</strong></td>
                                            <td>@Model.Analise.AnalisesPeso.MediaIMC</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Peso ideal médio:</strong></td>
                                            <td>@Model.Analise.AnalisesPeso.PesoIdealMedio kg</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Classificação predominante:</strong></td>
                                            <td>
                                                <span class="badge bg-secondary">@Model.Analise.AnalisesPeso.ClassificacaoIMCPredominante</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>% Peso normal:</strong></td>
                                            <td>
                                                <span class="badge @(Model.Analise.AnalisesPeso.PercentualPesoNormal >= 80 ? "bg-success" : Model.Analise.AnalisesPeso.PercentualPesoNormal >= 60 ? "bg-warning" : "bg-danger")">
                                                    @Model.Analise.AnalisesPeso.PercentualPesoNormal%
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Status geral:</strong></td>
                                            <td>@Model.Analise.AnalisesPeso.StatusPesoGeral</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tendência:</strong></td>
                                            <td>@Model.Analise.AnalisesPeso.TendenciaPeso</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        @if (Model.Analise.AnalisesPeso.Observacoes.Any())
                        {
                            <div class="mt-3">
                                <h6><strong>Observações:</strong></h6>
                                <ul>
                                    @foreach (var obs in Model.Analise.AnalisesPeso.Observacoes)
                                    {
                                        <li>@obs</li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Histórico de Medições -->
            @if (Model.Pressoes.Any() || Model.Glicoses.Any() || Model.Pesos.Any())
            {
                <div class="card shadow mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            Histórico de Medições (Últimas)
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (Model.Pressoes.Any())
                        {
                            <h6 class="text-primary">
                                <i class="fas fa-heartbeat me-2"></i>
                                Pressão Arterial
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Data/Hora</th>
                                            <th>Sistólica</th>
                                            <th>Diastólica</th>
                                            <th>FC</th>
                                            <th>Classificação</th>
                                            <th>Observações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var pressao in Model.Pressoes.Take(10))
                                        {
                                            <tr>
                                                <td>@pressao.DataHora.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>@pressao.Sistolica</td>
                                                <td>@pressao.Diastolica</td>
                                                <td>@pressao.FrequenciaCardiaca</td>
                                                <td>
                                                    <span class="badge @GetClassePressao(pressao.ClasseRisco)">
                                                        @pressao.ClassificacaoPressao
                                                    </span>
                                                </td>
                                                <td>@(pressao.Observacoes ?? "-")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }

                        @if (Model.Glicoses.Any())
                        {
                            <h6 class="text-success mt-4">
                                <i class="fas fa-droplet me-2"></i>
                                Glicose
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Data/Hora</th>
                                            <th>Valor</th>
                                            <th>Período</th>
                                            <th>Classificação</th>
                                            <th>Observações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var glicose in Model.Glicoses.Take(10))
                                        {
                                            <tr>
                                                <td>@glicose.DataHora.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>@glicose.Valor mg/dL</td>
                                                <td>@Html.DisplayFor(m => glicose.Periodo)</td>
                                                <td>
                                                    <span class="badge @GetClasseGlicose(glicose.ClasseRisco)">
                                                        @glicose.ClassificacaoGlicose
                                                    </span>
                                                </td>
                                                <td>@(glicose.Observacoes ?? "-")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }

                        @if (Model.Pesos.Any())
                        {
                            <h6 class="text-warning mt-4">
                                <i class="fas fa-weight me-2"></i>
                                Peso e IMC
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Data/Hora</th>
                                            <th>Peso (kg)</th>
                                            <th>Altura (cm)</th>
                                            <th>IMC</th>
                                            <th>Classificação</th>
                                            <th>Observações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var peso in Model.Pesos.Take(10))
                                        {
                                            <tr>
                                                <td>@peso.DataHora.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>@peso.PesoKg</td>
                                                <td>@peso.Altura</td>
                                                <td>@peso.IMC</td>
                                                <td>
                                                    <span class="badge @GetClassePeso(peso.ClasseRisco)">
                                                        @peso.ClassificacaoIMC
                                                    </span>
                                                </td>
                                                <td>@(peso.Observacoes ?? "-")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Valores de Referência -->
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        Valores de Referência
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-primary">Pressão Arterial (mmHg)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Classificação</th>
                                            <th>Sistólica</th>
                                            <th>Diastólica</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var referencia in Model.TabelasReferencia.ReferenciaPressao)
                                        {
                                            <tr>
                                                <td>@referencia.Classificacao</td>
                                                <td>@referencia.ValorSistolica</td>
                                                <td>@referencia.ValorDiastolica</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-success">Glicose (mg/dL)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Período</th>
                                            <th>Normal</th>
                                            <th>Pré-diabetes</th>
                                            <th>Diabetes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var referencia in Model.TabelasReferencia.ReferenciaGlicose)
                                        {
                                            <tr>
                                                <td>@referencia.Periodo</td>
                                                <td>@referencia.Normal</td>
                                                <td>@referencia.PreDiabetes</td>
                                                <td>@referencia.Diabetes</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-warning">Índice de Massa Corporal (IMC)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Classificação</th>
                                            <th>Faixa IMC</th>
                                            <th>Risco</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var referencia in Model.TabelasReferencia.ReferenciaIMC)
                                        {
                                            <tr>
                                                <td>@referencia.Classificacao</td>
                                                <td>@referencia.FaixaIMC</td>
                                                <td>@referencia.ClasseRisco</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Observações Médicas -->
            <div class="card shadow mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-notes-medical me-2"></i>
                        Observações Médicas
                    </h5>
                </div>
                <div class="card-body">
                    <pre class="mb-3" style="white-space: pre-wrap; font-family: inherit;">@Model.ObservacoesMedicas</pre>
                    
                    @if (!string.IsNullOrEmpty(Model.Analise.RecomendacoesGerais))
                    {
                        <h6><strong>Recomendações:</strong></h6>
                        <pre style="white-space: pre-wrap; font-family: inherit;">@Model.Analise.RecomendacoesGerais</pre>
                    }
                </div>
            </div>

            <!-- Disclaimer Médico -->
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Importante - Disclaimer Médico
                        </h6>
                        <p class="mb-0">@Model.DisclaimerMedico</p>
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="text-center mb-4">
                <a href="@Url.Action("Index")" class="btn btn-secondary me-2">
                    <i class="fas fa-arrow-left me-2"></i>
                    Voltar
                </a>
                <a href="@Url.Action("Gerar", new { 
                    DataInicial = Model.DataInicial, 
                    DataFinal = Model.DataFinal, 
                    TipoRelatorio = Model.TipoRelatorio, 
                    FormatoExportacao = FormatoExportacao.PDF 
                })" class="btn btn-primary me-2">
                    <i class="fas fa-file-pdf me-2"></i>
                    Baixar PDF
                </a>
                <a href="@Url.Action("Gerar", new { 
                    DataInicial = Model.DataInicial, 
                    DataFinal = Model.DataFinal, 
                    TipoRelatorio = Model.TipoRelatorio, 
                    FormatoExportacao = FormatoExportacao.Excel 
                })" class="btn btn-success">
                    <i class="fas fa-file-excel me-2"></i>
                    Baixar Excel
                </a>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetClassePressao(string classeRisco)
    {
        return classeRisco switch
        {
            "Baixo" => "bg-success",
            "Moderado" => "bg-warning",
            "Alto" => "bg-danger",
            "Muito Alto" => "bg-dark",
            _ => "bg-secondary"
        };
    }

    string GetClasseGlicose(string classeRisco)
    {
        return classeRisco switch
        {
            "Baixo" => "bg-success",
            "Moderado" => "bg-warning",
            "Alto" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetClassePeso(string classeRisco)
    {
        return classeRisco switch
        {
            "Baixo" => "bg-success",
            "Moderado" => "bg-warning",
            "Alto" => "bg-danger",
            "Muito Alto" => "bg-danger",
            "Extremamente Alto" => "bg-dark",
            _ => "bg-secondary"
        };
    }
}